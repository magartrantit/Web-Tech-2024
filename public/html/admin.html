<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body>
    <header>
        <a href="#" class="logo">ADMIN</a>
        <nav>
            <ul class="sidebar">
                <li onclick="hideSidebar()"><a href="#"><svg xmlns="http://www.w3.org/2000/svg" height="24"
                            viewBox="0 -960 960 960" width="24">
                            <path fill="white"
                                d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z" />
                        </svg></a></li>
                <a href="#" id="signout1">Sign out</a>

            </ul>
            <a href="#" id="signout">Sign out</a>

            <a href="#" class="menu-button" onclick=showSidebar()><svg xmlns="http://www.w3.org/2000/svg" height="24"
                    viewBox="0 -1200 960 960" width="24">
                    <path fill="white" d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z" />
                </svg></a>
        </nav>
    </header>

    <div class="main">
        <div id="adminAccount">
            <h2>Administrate Account of User</h2>
            <select id="userSelect"></select>
            <button onclick="deleteUser()">Delete User</button>
            <button onclick="modifyDates()">Modify Dates</button>
        </div>

        <div id="userMessages">
            <h2>Messages from Users</h2>
            <p id="messageContent">Message content goes here</p>
            <button onclick="respondToMessage()">Respond</button>
            <button onclick="deleteMessage()">Delete</button>
        </div>

        <div id="addProduct">
            <h2>Add Product</h2>
            <button onclick="addProduct()">Add Product</button>
        </div>

        <div id="modifyUserPopup" class="popup">
            <div class="popup-content">
                <span class="close" onclick="closeModifyUserPopup()">&times;</span>
                <h2>Modify User</h2>
                <form id="modifyUserForm">
                    <input type="text" id="newUsername" name="newUsername" placeholder="New Username">
                    <input type="password" id="newPassword" name="newPassword" placeholder="New Password">
                    <button type="button" onclick="submitModifyUser()">Save Changes</button>
                </form>
            </div>
        </div>


        <div id="addProductPopup" class="popup">
            <div class="popup-content">
                <span class="close" onclick="closePopup()">&times;</span>
                <h2>Add New Product</h2>
                <form id="addProductForm" action="/api/products" method="post" enctype="multipart/form-data">
                    <input type="text" id="code" name="code" placeholder="Code">
                    <input type="text" id="url" name="url" placeholder="Url">
                    <input type="text" id="product_name" name="product_name" placeholder="Product Name">
                    <input type="text" id="brands" name="brands" placeholder="Brands">
                    <input type="text" id="categories_en" name="categories_en" placeholder="Categories">
                    <input type="text" id="countries_en" name="countries_en" placeholder="Countries">
                    <input type="text" id="ingredients_text" name="ingredients_text" placeholder="Ingredients Text">
                    <input type="text" id="allergens" name="allergens" placeholder="Allergens">
                    <input type="text" id="additives_en" name="additives_en" placeholder="Additives">
                    <input type="text" id="food_groups_en" name="food_groups_en" placeholder="Food Groups">
                    <input type="text" id="main_category_en" name="main_category_en" placeholder="Main Category">
                    <input type="text" id="image_url" name="image_url" placeholder="Image URL" required>
                    <input type="text" id="image_ingredients_url" name="image_ingredients_url"
                        placeholder="Image Ingredients URL" required>
                    <input type="text" id="image_nutrition_url" name="image_nutrition_url"
                        placeholder="Image Nutrition URL" required>
                    <input type="text" id="energy-kcal_100g" name="energy-kcal_100g" placeholder="Energy kcal/100g">
                    <input type="text" id="fat_100g" name="fat_100g" placeholder="Fat/100g">
                    <input type="text" id="saturated-fat_100g" name="saturated-fat_100g"
                        placeholder="Saturated Fat/100g">
                    <input type="text" id="carbohydrates_100g" name="carbohydrates_100g"
                        placeholder="Carbohydrates/100g">
                    <input type="text" id="sugars_100g" name="sugars_100g" placeholder="Sugars/100g">
                    <input type="text" id="fiber_100g" name="fiber_100g" placeholder="Fiber/100g">
                    <input type="text" id="proteins_100g" name="proteins_100g" placeholder="Proteins/100g">
                    <input type="text" id="salt_100g" name="salt_100g" placeholder="Salt/100g">
                    <input type="text" id="sodium_100g" name="sodium_100g" placeholder="Sodium/100g">
                    <input type="text" id="restaurants" name="restaurants" placeholder="Price">
                    <input type="text" id="price" name="price" placeholder="Restaurants">
                    <button type="button" onclick="submitProduct()">Submit</button>
                </form>
            </div>
        </div>

        <div id="errorPopup" class="popup hidden">
            <div class="popup-content">
                <span class="close" onclick="closeErrorPopup()">&times;</span>
                <h2>Error</h2>
                <p>All fields must be filled and an image URL must be provided.</p>
            </div>
        </div>


    </div>

    <script>

        window.onload = async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
            }

            const response = await fetch('/api/protected', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                window.location.href = '/admin';
            }
        }

        function modifyDates() {
            document.getElementById("modifyUserPopup").style.display = "block";
        }

        function closeModifyUserPopup() {
            document.getElementById("modifyUserPopup").style.display = "none";
        }

        function submitModifyUser() {
            const userId = document.getElementById('userSelect').value;
            const newUsername = document.getElementById('newUsername').value;
            const newPassword = document.getElementById('newPassword').value;

            // Verifică dacă s-au introdus date valide
            if (!userId || (!newUsername && !newPassword)) {
                alert('Please select a user and provide at least new username or password.');
                return;
            }

            const requestData = {};
            if (newUsername) requestData.username = newUsername;
            if (newPassword) requestData.password = newPassword;

            // Asigurați-vă că utilizați JSON.stringify pentru a converti obiectul requestData într-un șir JSON
            fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData), // Converteste obiectul requestData într-un șir JSON
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => Promise.reject(err));
                    }
                    return response.json();
                })
                .then(data => {
                    
                    closeModifyUserPopup();
                })
                .catch(error => {
                    console.error('Error updating user:', error);
                });
        }

        function addProduct() {
            document.getElementById("addProductPopup").style.display = "block";
        }

        function closePopup() {
            document.getElementById("addProductPopup").style.display = "none";
        }

        function closeErrorPopup() {
            document.getElementById("errorPopup").style.display = "none";
        }

        function submitProduct() {
            var form = document.getElementById("addProductForm");
            var fields = form.querySelectorAll('input[type="text"]');
            var allFieldsFilled = Array.from(fields).every(field => field.value.trim() !== "");

            if (!allFieldsFilled) {
                document.getElementById("errorPopup").style.display = "block";
                return;
            }

            var formData = new FormData(form);
            fetch('/api/products', {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    closePopup();
                    form.reset();
                } else {
                    alert('Error submitting the product');
                }
            }).catch(error => {
                console.error('Error:', error);
            });
        }



        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded and parsed');
            fetchUsers();
        });

        function fetchUsers() {
            fetch('/api/users')
                .then(response => response.json())
                .then(data => {
                    console.log('Fetched users:', data);
                    const userSelect = document.getElementById('userSelect');
                    data.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        userSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching users:', error));
        }

        function deleteUser() {
            const userId = document.getElementById('userSelect').value;
            console.log('Deleting user with ID:', userId);
            fetch(`/api/users/${userId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        showMessage('User deleted successfully');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        alert('Error deleting user');
                    }
                })
                .catch(error => console.error('Error deleting user:', error));
        }

        document.getElementById('signout').addEventListener('click', () => {
            // La click pe butonul de delogare, se elimină tokenul din stocarea locală
            localStorage.removeItem('token');
            // Și se redirecționează utilizatorul către pagina de autentificare
            window.location.href = '/login';
        });


        document.getElementById('signout1').addEventListener('click', () => {
            // La click pe butonul de delogare, se elimină tokenul din stocarea locală
            localStorage.removeItem('token');
            // Și se redirecționează utilizatorul către pagina de autentificare
            window.location.href = '/login';
        });

    </script>
</body>

</html>